<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hy-Bridge Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    body { font-family: 'Pretendard', sans-serif; background-color: #F8F9FA; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; text-align:center; }
    .day { height:46px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; border-radius:999px; cursor:pointer; }
    .day:hover { background:#f3f4f6; }
    .dots { position:absolute; bottom:6px; display:flex; gap:3px; }
    .dot { width:5px; height:5px; border-radius:999px; }
  </style>
</head>

<body class="pb-24 max-w-md mx-auto bg-white min-h-screen border-x border-gray-200 relative">

<header class="p-5 flex items-center justify-between">
  <h1 class="text-xl font-bold">2026년 4월</h1>
  <div class="flex gap-2">
    <button class="w-8 h-8 rounded-full bg-gray-100"><i class="fa-solid fa-chevron-left text-xs"></i></button>
    <button class="w-8 h-8 rounded-full bg-gray-100"><i class="fa-solid fa-chevron-right text-xs"></i></button>
  </div>
</header>

<main class="px-5">
  <div class="calendar-grid mb-2 text-gray-400 text-xs font-bold">
    <div class="text-red-400">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-400">토</div>
  </div>

  <!-- 간단 데모 달력(4월 일부만) -->
  <div class="calendar-grid text-sm font-medium text-gray-800" id="cal">
    <div></div><div></div><div></div>
    <div class="day" data-date="2026-04-01"><span>1</span></div>
    <div class="day" data-date="2026-04-02"><span>2</span></div>
    <div class="day" data-date="2026-04-03"><span>3</span></div>
    <div class="day" data-date="2026-04-04"><span>4</span></div>

    <div class="day" data-date="2026-04-15"><span>15</span></div>
    <div class="day" data-date="2026-04-16"><span>16</span></div>
    <div class="day" data-date="2026-04-17"><span>17</span></div>
    <div class="day" data-date="2026-04-18"><span>18</span></div>
    <div class="day" data-date="2026-04-19"><span>19</span></div>

    <div class="day" data-date="2026-04-20"><span>20</span></div>
    <div class="day" data-date="2026-04-21"><span>21</span></div>
    <div class="day" data-date="2026-04-22"><span>22</span></div>
    <div class="day" data-date="2026-04-23"><span>23</span></div>
  </div>

  <div class="flex justify-end gap-3 mt-4 text-xs text-gray-500">
    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>학교 일정</div>
    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>AI 예보</div>
  </div>

  <hr class="my-6 border-gray-100">

  <h3 class="font-bold text-gray-800 mb-3" id="dayTitle">날짜를 선택하세요</h3>

  <!-- 경고/상세 카드 -->
  <div id="conflictCard" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl mb-4">
    <div class="flex items-center gap-2 mb-1">
      <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
      <span class="text-red-700 font-bold text-sm">일정 충돌 경고!</span>
    </div>
    <p class="text-xs text-red-600" id="conflictText"></p>
    <button id="goLog" class="mt-3 w-full bg-black text-white py-3 rounded-xl text-sm font-bold">
      지금 기록(자소서 소스) 만들어두기
    </button>
  </div>

  <!-- 일정 리스트 -->
  <div class="space-y-3" id="scheduleList"></div>
</main>

<nav class="fixed bottom-0 w-full max-w-md bg-white h-20 border-t border-gray-100 flex justify-around items-center z-50">
  <a href="index.html" class="flex flex-col items-center text-gray-300 w-full h-full justify-center hover:text-gray-500">
    <i class="fa-solid fa-house text-xl mb-1"></i>
    <span class="text-[10px] font-medium">홈</span>
  </a>
  <a href="log.html" class="flex flex-col items-center text-gray-300 w-full h-full justify-center hover:text-gray-500">
    <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
    <span class="text-[10px] font-medium">로그</span>
  </a>
  <a href="career.html" class="flex flex-col items-center text-gray-300 w-full h-full justify-center hover:text-gray-500">
    <i class="fa-solid fa-briefcase text-xl mb-1"></i>
    <span class="text-[10px] font-medium">커리어</span>
  </a>
  <a href="calendar.html" class="flex flex-col items-center text-yellow-500 w-full h-full justify-center border-t-2 border-yellow-500">
    <i class="fa-solid fa-calendar-days text-xl mb-1"></i>
    <span class="text-[10px] font-bold">캘린더</span>
  </a>
</nav>

<script>
  const KEY_OPPS = "hybridge_opportunities_v1";
  const KEY_EVENTS = "hybridge_school_events_v1";
  const KEY_DRAFT = "hybridge_log_draft_v1";

  // 데모용 학교 일정(빨간 점) 기본값 1회 세팅
  function seedSchoolEvents(){
    const existing = JSON.parse(localStorage.getItem(KEY_EVENTS) || "[]");
    if (existing.length) return;
    const seeded = [
      { id:"exam-1", title:"사회학이론 중간고사", date:"2026-04-20", time:"09:00", type:"school" }
    ];
    localStorage.setItem(KEY_EVENTS, JSON.stringify(seeded));
  }
  seedSchoolEvents();

  function getOpps(){ return JSON.parse(localStorage.getItem(KEY_OPPS) || "[]"); }
  function getEvents(){ return JSON.parse(localStorage.getItem(KEY_EVENTS) || "[]"); }

  function renderDots(){
    const oppByDate = new Map();
    getOpps().forEach(o => oppByDate.set(o.predictedDate, (oppByDate.get(o.predictedDate)||0)+1));
    const eventByDate = new Map();
    getEvents().forEach(e => eventByDate.set(e.date, (eventByDate.get(e.date)||0)+1));

    document.querySelectorAll(".day").forEach(cell => {
      const date = cell.dataset.date;
      const hasYellow = oppByDate.has(date);
      const hasRed = eventByDate.has(date);

      // cleanup
      const old = cell.querySelector(".dots");
      if (old) old.remove();

      if (hasYellow || hasRed){
        const dots = document.createElement("div");
        dots.className = "dots";
        if (hasRed){
          const d = document.createElement("span");
          d.className = "dot bg-red-500";
          dots.appendChild(d);
        }
        if (hasYellow){
          const d = document.createElement("span");
          d.className = "dot bg-yellow-400";
          dots.appendChild(d);
        }
        cell.appendChild(dots);

        // 겹침 표시(배경)
        if (hasRed && hasYellow){
          cell.classList.add("bg-red-50","border","border-red-200");
          cell.querySelector("span").classList.add("text-red-600","font-bold");
        }
      }
    });
  }

  function selectDate(date, focusOppId){
    document.getElementById("dayTitle").textContent = `${date} 일정`;

    const list = document.getElementById("scheduleList");
    list.innerHTML = "";

    const events = getEvents().filter(e => e.date === date);
    const opps = getOpps().filter(o => o.predictedDate === date);

    // 일정 카드 렌더
    events.forEach(e => {
      const row = document.createElement("div");
      row.className = "flex gap-3";
      row.innerHTML = `
        <div class="text-xs font-bold text-gray-400 w-12 pt-1">${e.time || "—"}</div>
        <div class="bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm font-bold flex-1">
          ${escapeHTML(e.title)}
        </div>
      `;
      list.appendChild(row);
    });

    opps.forEach(o => {
      const row = document.createElement("div");
      row.className = "flex gap-3";
      row.innerHTML = `
        <div class="text-xs font-bold text-gray-400 w-12 pt-1">—</div>
        <div class="bg-yellow-100 text-yellow-700 px-3 py-2 rounded-lg text-sm font-bold flex-1 border border-yellow-300 border-dashed">
          [예상] ${escapeHTML(o.title)}
        </div>
      `;
      list.appendChild(row);
    });

    // 충돌 카드
    const conflict = (events.length > 0 && opps.length > 0);
    const conflictCard = document.getElementById("conflictCard");
    const conflictText = document.getElementById("conflictText");

    if (conflict){
      const oppTitle = opps[0]?.title || "예보 일정";
      const evTitle  = events[0]?.title || "학교 일정";
      conflictText.innerHTML = `중요 일정 <b>${escapeHTML(evTitle)}</b>과 <b>${escapeHTML(oppTitle)}</b>가 겹칩니다.<br>지금 기록해두면 놓칠 확률이 확 내려가요.`;
      conflictCard.classList.remove("hidden");

      // Log로 넘어갈 때 Draft에 context 저장(자동 채움)
      document.getElementById("goLog").onclick = () => {
        const draft = {
          title: oppTitle,
          category: "대외활동",
          date: date,
          raw_text: "오늘 무엇을 했나요? (예: 준비할 서류/자소서 소스/경험 정리)\n- \n- \n"
        };
        localStorage.setItem(KEY_DRAFT, JSON.stringify(draft));
        location.href = `log.html?from=calendar&date=${encodeURIComponent(date)}&opp=${encodeURIComponent(focusOppId||"")}`;
      };
    } else {
      conflictCard.classList.add("hidden");
    }
  }

  function escapeHTML(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // click handlers
  document.querySelectorAll(".day").forEach(cell => {
    cell.addEventListener("click", () => {
      selectDate(cell.dataset.date);
    });
  });

  // initial render
  renderDots();

  // focus via query
  const qs = new URLSearchParams(location.search);
  const focus = qs.get("focus");
  const oppId = qs.get("opp");
  if (focus){
    selectDate(focus, oppId);
  }
</script>

</body>
</html>
